<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Campus Network Visualizer</title>
  <!-- Konva.js CDN -->
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #12162a;
      --accent: #7c3aed;
      --muted: #a5b4fc;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --ink: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: radial-gradient(1200px 800px at 80% -20%, #1f254a 0%, var(--bg) 50%);
      height: 100vh; display: grid; grid-template-columns: 320px 1fr 340px; grid-template-rows: 56px 1fr; grid-template-areas:
        'top top top'
        'left canvas right';
      gap: 10px;
    }
    header {
      grid-area: top;
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; background: var(--panel); border-bottom: 1px solid #2a3054; box-shadow: 0 6px 24px rgba(0,0,0,.25);
    }
    header .brand { font-weight: 800; letter-spacing: .5px; }
    header .brand span { color: var(--accent); }
    .pill {
      font-size: 12px; padding: 6px 10px; background: #1a1f3a; border: 1px solid #2a3054; border-radius: 999px; color: var(--muted);
    }
    aside#toolbox { grid-area: left; background: var(--panel); border: 1px solid #2a3054; border-radius: 16px; padding: 12px; overflow: auto; }
    aside#inspector { grid-area: right; background: var(--panel); border: 1px solid #2a3054; border-radius: 16px; padding: 12px; overflow: auto; }
    #stageWrap { grid-area: canvas; position: relative; background: #0b0f24; border: 1px solid #2a3054; border-radius: 16px; overflow: hidden; }
    #stage { position: absolute; inset: 0; }

    .section { margin-bottom: 16px; }
    .section h3 { margin: 8px 0 8px; font-size: 13px; text-transform: uppercase; color: var(--muted); letter-spacing: .1em; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      appearance: none; border: 1px solid #30365f; background: #171b34; color: var(--ink); padding: 8px 10px; border-radius: 12px; font-size: 13px; cursor: pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease; user-select: none;
    }
    .btn:hover { background: #1b2040; border-color: #3a4174; }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn.icon { display: inline-flex; align-items: center; gap: 8px; }
    .btn.full { width: 100%; justify-content: center; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid #30365f; background: #10142b; color: var(--muted); }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px; font-size: 12px; }

    .stat {
      display: grid; grid-template-columns: 1fr auto; gap: 4px; padding: 8px 10px; background: #0e1330; border: 1px solid #2a3054; border-radius: 12px; align-items: center;
    }
    .stat .label { color: var(--muted); font-size: 12px; }
    .stat .value { font-weight: 700; }

    .alert { border-left: 4px solid var(--warn); padding: 8px 10px; background: #171b34; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
    .alert.err { border-left-color: var(--err); }
    .alert.ok { border-left-color: var(--ok); }

    .divider { height: 1px; background: #262d55; margin: 10px 0; }

    .tooltip { position: absolute; pointer-events: none; background: #0b0f24; border: 1px solid #2a3054; color: var(--ink); padding: 6px 8px; border-radius: 8px; font-size: 12px; opacity: 0; transform: translateY(-6px); transition: opacity .08s ease, transform .08s ease; z-index: 5; }

    .grid-overlay { position: absolute; inset: 0; background-image: linear-gradient(transparent 95%, rgba(124,58,237,.15) 95%), linear-gradient(90deg, transparent 95%, rgba(124,58,237,.15) 95%); background-size: 40px 40px; opacity: .6; pointer-events: none; }

  </style>
</head>
<body>
  <header>
    <div class="brand">Smart<span>Campus</span> Visualizer</div>
    <div class="pill" id="clock">--:--:--</div>
  </header>

  <aside id="toolbox">
    <div class="section">
      <h3>Devices</h3>
      <div class="row" id="palette"></div>
    </div>
    <div class="section">
      <h3>Link Tools</h3>
      <div class="row">
        <button class="btn icon" id="toggleLinkMode">üîó Link Mode</button>
        <button class="btn icon" id="simulateTraffic">‚ñ∂Ô∏è Simulate</button>
        <button class="btn icon" id="clear">üßπ Clear</button>
      </div>
    </div>
    <div class="section">
      <h3>Campus Zones</h3>
      <div class="row">
        <span class="badge">Library</span>
        <span class="badge">Admin</span>
        <span class="badge">Hostel</span>
        <span class="badge">Labs</span>
        <span class="badge">Sports</span>
      </div>
    </div>
    <div class="section">
      <h3>Legend</h3>
      <div class="legend">
        <div>Online</div><div>‚óè</div>
        <div>Warning</div><div>‚óè‚óè</div>
        <div>Offline</div><div>√ó</div>
      </div>
    </div>
  </aside>

  <div id="stageWrap">
    <div id="stage"></div>
    <div class="grid-overlay"></div>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <aside id="inspector">
    <div class="section">
      <h3>Overview</h3>
      <div class="stat"><div class="label">Devices</div><div class="value" id="statDevices">0</div></div>
      <div class="stat"><div class="label">Links</div><div class="value" id="statLinks">0</div></div>
      <div class="stat"><div class="label">Alerts</div><div class="value" id="statAlerts">0</div></div>
    </div>
    <div class="divider"></div>
    <div class="section">
      <h3>Selection</h3>
      <div id="selection">Nothing selected</div>
    </div>
    <div class="divider"></div>
    <div class="section">
      <h3>Alerts</h3>
      <div id="alerts"></div>
    </div>
  </aside>

  <script>
    // ----- Utilities -----
    const $ = (sel) => document.querySelector(sel);
    const rnd = (min, max) => Math.random() * (max - min) + min;
    const uuid = () => Math.random().toString(36).slice(2, 9);

    // ----- Clock -----
    const clock = () => {
      const d = new Date();
      $('#clock').textContent = d.toLocaleTimeString();
    };
    setInterval(clock, 1000); clock();

    // ----- Konva Setup -----
    const stageEl = document.getElementById('stage');
    const STAGE_W = stageEl.clientWidth || (window.innerWidth - 680);
    const STAGE_H = stageEl.clientHeight || (window.innerHeight - 80);

    const stage = new Konva.Stage({ container: 'stage', width: STAGE_W, height: STAGE_H });
    const gridLayer = new Konva.Layer();
    const linkLayer = new Konva.Layer();
    const nodeLayer = new Konva.Layer();
    const fxLayer = new Konva.Layer();
    stage.add(gridLayer, linkLayer, nodeLayer, fxLayer);

    // Draw soft background "zones"
    const zones = [
      { name: 'Library', x: 60, y: 60, w: 320, h: 220, color: 'rgba(124,58,237,0.08)' },
      { name: 'Admin', x: 420, y: 40, w: 300, h: 160, color: 'rgba(34,197,94,0.08)' },
      { name: 'Labs', x: 80, y: 320, w: 360, h: 220, color: 'rgba(59,130,246,0.08)' },
      { name: 'Hostel', x: 480, y: 240, w: 360, h: 240, color: 'rgba(245,158,11,0.08)' }
    ];
    zones.forEach(z => {
      const g = new Konva.Group({ x: z.x, y: z.y });
      const r = new Konva.Rect({ width: z.w, height: z.h, cornerRadius: 16, fill: z.color, stroke: '#2a3054', strokeWidth: 1 });
      const t = new Konva.Text({ text: z.name, x: 8, y: 6, fontSize: 12, fill: '#a5b4fc' });
      g.add(r, t); gridLayer.add(g);
    });
    gridLayer.draw();

    // ----- Data Model -----
    const state = {
      nodes: [], // {id, type, name, group, icon, status, x, y}
      links: [], // {id, a, b, bandwidth, latency, line}
      linkMode: false,
      sourceNode: null,
      simulating: false,
      alerts: []
    };

    const deviceTypes = [
      { type: 'Router', icon: 'üõú', color: '#7c3aed' },
      { type: 'Switch', icon: 'üßÆ', color: '#06b6d4' },
      { type: 'AP', icon: 'üì°', color: '#22c55e' },
      { type: 'Server', icon: 'üóÑÔ∏è', color: '#f59e0b' },
      { type: 'Camera', icon: 'üé•', color: '#e11d48' },
      { type: 'IoT', icon: 'üìü', color: '#8b5cf6' }
    ];

    // ----- Palette (drag-to-canvas) -----
    const palette = document.getElementById('palette');
    deviceTypes.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'btn icon';
      btn.textContent = `${d.icon} ${d.type}`;
      btn.style.borderColor = '#2a3054';
      btn.addEventListener('click', () => addNodeAtCenter(d.type));
      palette.appendChild(btn);
    });

    function addNodeAtCenter(type) {
      const x = stage.width()/2 + rnd(-80, 80);
      const y = stage.height()/2 + rnd(-60, 60);
      addNode({ type, x, y });
    }

    function addNode({ type, x, y }) {
      const meta = deviceTypes.find(t => t.type === type) || deviceTypes[0];
      const id = uuid();
      const name = `${type}-${state.nodes.filter(n => n.type === type).length + 1}`;
      const status = ['online','online','online','warn','offline'][Math.floor(rnd(0,5))];

      const group = new Konva.Group({ x, y, draggable: true, id });
      const circle = new Konva.Circle({ radius: 22, fill: '#111638', stroke: meta.color, strokeWidth: 2, shadowColor: meta.color, shadowBlur: 12, shadowOpacity: .4 });
      const text = new Konva.Text({ text: meta.icon, fontSize: 20, align: 'center', verticalAlign: 'middle', width: 44, height: 44, offsetX: 22, offsetY: 22 });
      const label = new Konva.Label({ y: 30 });
      label.add(new Konva.Tag({ fill: '#0b0f24', stroke: '#2a3054', lineJoin: 'round', cornerRadius: 6 }));
      label.add(new Konva.Text({ text: name, fontSize: 12, padding: 4, fill: '#c7d2fe' }));

      const statusDot = new Konva.Circle({ x: 18, y: -18, radius: 5, fill: statusColor(status) });

      group.add(circle, text, statusDot, label);
      nodeLayer.add(group); nodeLayer.draw();

      const node = { id, type, name, group, icon: meta.icon, status, x, y };
      state.nodes.push(node);
      updateStats();

      group.on('dragmove', () => {
        node.x = group.x(); node.y = group.y();
        updateLinksForNode(id);
      });

      group.on('mouseover', () => showTooltip(`${meta.icon} ${name}\nStatus: ${status.toUpperCase()}`));
      group.on('mouseout', hideTooltip);
      group.on('mouseenter', () => stage.container().style.cursor = 'grab');
      group.on('dragstart', () => stage.container().style.cursor = 'grabbing');
      group.on('dragend', () => stage.container().style.cursor = 'default');

      group.on('click', () => handleNodeClick(node));

      return node;
    }

    function statusColor(s) {
      return s === 'online' ? '#22c55e' : s === 'warn' ? '#f59e0b' : '#ef4444';
    }

    // ----- Tooltip -----
    const tip = document.getElementById('tooltip');
    function showTooltip(text) {
      tip.textContent = text;
      const p = stage.getPointerPosition();
      tip.style.left = (p.x + 14) + 'px';
      tip.style.top = (p.y - 10) + 'px';
      tip.style.opacity = '1';
      tip.style.transform = 'translateY(0)';
    }
    function hideTooltip() { tip.style.opacity = '0'; tip.style.transform = 'translateY(-6px)'; }

    // ----- Link creation -----
    function handleNodeClick(node) {
      select(node);
      if (!state.linkMode) return;
      if (!state.sourceNode) {
        state.sourceNode = node;
        pulse(node.group);
        return;
      }
      if (state.sourceNode.id === node.id) { return; }
      createLink(state.sourceNode, node);
      state.sourceNode = null;
      state.linkMode = false; $('#toggleLinkMode').classList.remove('active');
    }

    function createLink(a, b) {
      const id = uuid();
      const line = new Konva.Arrow({
        points: [a.group.x(), a.group.y(), b.group.x(), b.group.y()],
        stroke: '#4751a3', fill: '#4751a3', strokeWidth: 2, pointerWidth: 8, pointerAtEnding: true, tension: 0
      });
      linkLayer.add(line); linkLayer.draw();

      const link = { id, a: a.id, b: b.id, bandwidth: Math.round(rnd(50, 1000)), latency: Math.round(rnd(1, 100)), line };
      state.links.push(link);
      updateStats();
      maybeAlertForLink(link);
    }

    function updateLinksForNode(nodeId) {
      state.links.forEach(l => {
        if (l.a === nodeId || l.b === nodeId) {
          const na = state.nodes.find(n => n.id === l.a);
          const nb = state.nodes.find(n => n.id === l.b);
          l.line.points([na.group.x(), na.group.y(), nb.group.x(), nb.group.y()]);
        }
      });
      linkLayer.batchDraw();
    }

    function select(node) {
      const meta = deviceTypes.find(t => t.type === node.type);
      $('#selection').innerHTML = `
        <div class="stat"><div class="label">Name</div><div class="value">${node.name}</div></div>
        <div class="stat"><div class="label">Type</div><div class="value">${node.type}</div></div>
        <div class="stat"><div class="label">Status</div><div class="value" style="color:${statusColor(node.status)}">${node.status.toUpperCase()}</div></div>
        <div class="row" style="margin-top:8px;">
          <button class="btn" onclick="toggleStatus('${node.id}')">Toggle Status</button>
          <button class="btn" onclick="blinkNode('${node.id}')">Highlight</button>
          <button class="btn" onclick="removeNode('${node.id}')">Remove</button>
        </div>
      `;
    }

    window.toggleStatus = (id) => {
      const node = state.nodes.find(n => n.id === id);
      if (!node) return;
      node.status = node.status === 'online' ? 'offline' : node.status === 'offline' ? 'warn' : 'online';
      node.group.findOne('Circle:nth-child(3)').fill(statusColor(node.status)); // statusDot is 3rd added
      nodeLayer.draw();
      addAlert(`${node.name} is now ${node.status.toUpperCase()}`, node.status === 'offline' ? 'err' : node.status === 'warn' ? 'warn' : 'ok');
    }

    window.blinkNode = (id) => {
      const node = state.nodes.find(n => n.id === id);
      if (!node) return;
      pulse(node.group);
    }

    window.removeNode = (id) => {
      const node = state.nodes.find(n => n.id === id);
      if (!node) return;
      // remove links
      state.links = state.links.filter(l => {
        if (l.a === id || l.b === id) { l.line.destroy(); return false; }
        return true;
      });
      // remove node
      node.group.destroy();
      state.nodes = state.nodes.filter(n => n.id !== id);
      linkLayer.draw(); nodeLayer.draw();
      updateStats();
    }

    function pulse(group) {
      const c = group.findOne('Circle');
      c.to({ scaleX: 1.15, scaleY: 1.15, duration: .12, yoyo: true, onFinish: () => {} });
    }

    // ----- Simulation -----
    function animateTraffic() {
      if (!state.simulating) return;
      state.links.forEach(l => spawnPacketAlong(l));
      setTimeout(animateTraffic, 900);
    }

    function spawnPacketAlong(link) {
      const pts = link.line.points();
      const [x1, y1, x2, y2] = pts;
      const dot = new Konva.Circle({ x: x1, y: y1, radius: 3, fill: '#a5b4fc' });
      fxLayer.add(dot);
      const duration = Math.max(.6, Math.min(3, link.latency / 40));
      dot.to({ x: x2, y: y2, duration, onFinish: () => dot.destroy() });
    }

    function maybeAlertForLink(link) {
      if (link.bandwidth < 100) {
        addAlert(`Low bandwidth on link (${link.bandwidth} Mbps)`, 'warn');
      }
      if (link.latency > 80) {
        addAlert(`High latency on link (${link.latency} ms)`, 'warn');
      }
    }

    function addAlert(text, level = 'warn') {
      const el = document.createElement('div');
      el.className = 'alert ' + (level === 'err' ? 'err' : level === 'ok' ? 'ok' : '');
      el.textContent = text;
      $('#alerts').prepend(el);
      state.alerts.unshift({ id: uuid(), text, level, ts: Date.now() });
      if (state.alerts.length > 20) { state.alerts.pop(); $('#alerts').lastChild?.remove(); }
      updateStats();
    }

    function updateStats() {
      document.getElementById('statDevices').textContent = state.nodes.length;
      document.getElementById('statLinks').textContent = state.links.length;
      document.getElementById('statAlerts').textContent = state.alerts.length;
    }

    // ----- Buttons -----
    document.getElementById('toggleLinkMode').addEventListener('click', () => {
      state.linkMode = !state.linkMode;
      state.sourceNode = null;
      addAlert(state.linkMode ? 'Link Mode: Click two nodes to connect' : 'Link Mode off', 'ok');
    });

    document.getElementById('simulateTraffic').addEventListener('click', () => {
      state.simulating = !state.simulating;
      if (state.simulating) { addAlert('Simulation started', 'ok'); animateTraffic(); }
      else { addAlert('Simulation stopped', 'ok'); }
    });

    document.getElementById('clear').addEventListener('click', () => {
      state.links.forEach(l => l.line.destroy());
      state.nodes.forEach(n => n.group.destroy());
      state.nodes = []; state.links = []; state.alerts = [];
      $('#alerts').innerHTML = '';
      updateStats();
    });

    // ----- Starter layout -----
    const r1 = addNode({ type: 'Router', x: 220, y: 140 });
    const sw1 = addNode({ type: 'Switch', x: 220, y: 240 });
    const ap1 = addNode({ type: 'AP', x: 140, y: 360 });
    const ap2 = addNode({ type: 'AP', x: 300, y: 360 });
    const cam = addNode({ type: 'Camera', x: 520, y: 300 });
    const srv = addNode({ type: 'Server', x: 630, y: 120 });

    createLink(r1, sw1);
    createLink(sw1, ap1);
    createLink(sw1, ap2);
    createLink(r1, srv);
    createLink(sw1, cam);

    // ----- Resize handling -----
    window.addEventListener('resize', () => {
      const w = document.getElementById('stageWrap').clientWidth;
      const h = document.getElementById('stageWrap').clientHeight;
      stage.size({ width: w, height: h });
      nodeLayer.draw(); linkLayer.draw();
    });

    // ----- Pointer tooltip follow -----
    stage.on('mousemove', () => {
      if (tip.style.opacity === '1') {
        const p = stage.getPointerPosition();
        tip.style.left = (p.x + 14) + 'px';
        tip.style.top = (p.y - 10) + 'px';
      }
    });
  </script>
</body>
</html>
